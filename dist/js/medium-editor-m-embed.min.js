/*! m-embed 1.0.3 by dotburo (http://www.dotburo.org) license: GPL-3.0+ */
!function(e,t){"function"==typeof define&&define.amd?define(["MediumEditor"],t):"object"==typeof exports?module.exports=t(require("medium-editor")):e.MEmbed=t(e.MediumEditor)}(this,function(e){"use strict";var t=function(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")},i=function(e){return e.status>=200&&e.status<300||304===e.status},s=function(e,t){var s=this,n=new XMLHttpRequest;s.emit("progress",0),n.open("GET",s.options.fakeData||e,!0),n.onreadystatechange=function(){var e,a;4===n.readyState&&(e=JSON.parse(n.responseText),i(n)?(e.originalURL=t,s.emit("success",e)):(a=e.error_message?e.error_message+" ("+e.error_code+").":n.statusText?n.statusText+" ("+n.status+").":"The request encountered and error, please try again later ("+n.status+").",s.emit("error",{msg:a,xhr:n})))},n.onprogress=function(e){e.lengthComputable&&s.emit("progress",e.loaded/e.total*100)},n.send()},n=function(e){this.extension=e,this.options=e.options};n.prototype={urlRe:/(http|https):\/\/(\w+:?\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/,buildURL:function(e){var i,s,n,a=this.options,r=a.endpoint;return i=a.secure,i||(i="https:"===this.extension.window.location.protocol),s=(i?"https":"http")+"://api.embed.ly/1/"+r,n=a.query||{},n.key=a.key,n.url=e,s+="?"+t(n)},init:function(e,t){var i=!0;return this.viewId=t.viewId,this.editor=t.editor,e?(t=this.extension.extend({},this.options,t||{}),t.key||t.fakeData?(t.urlRe&&t.urlRe.test&&!t.urlRe.test(e)&&(i=!1),i?void s.call(this,this.buildURL(e),e):void this.emit("error","The proposed URL is invalid.")):void this.emit("error","An API Key is required to fetch and embed.")):void this.emit("error","There is no URL to embed.")},emit:function(e,t){"object"!=typeof t&&(t={msg:t}),t.viewId=this.viewId,this.extension.trigger("m-embed:"+e,t,this.editor)}};var a=0,r=0,o=null,l=function(e,t,i){this.doc=e.document,this.isClean=!0,this.id=a++,this.editorIndex=i,this.options=e.options,this.extension=e,this.editor=t,this.els={},this.events={},this.addCustomEvent("m-embed","progress",this.showProgress,this),this.addCustomEvent("m-embed","success",this.initPreview,this),this.addCustomEvent("m-embed","swap",this.swapVisual,this),this.options.displayErrors&&this.addCustomEvent("m-embed","error",this.showError,this)};l.prototype={addCustomEvent:function(e,t,i,s){i=i.bind(s),this.extension.subscribe(e+":"+t,i),this.events[t]=function(){s.extension.base.unsubscribe(e+":"+t,i)}},addEvent:function(e,t,i,s){var n=this;"function"==typeof i&&(s=i,i=++r),this.extension.on(e,t,s),this.events[i]=function(){n.extension.off(e,t,s)}},isViewOfEvent:function(e,t){return e.viewId===this.id&&t.getAttribute("medium-editor-index")==this.editorIndex},showProgress:function(e,t){this.isViewOfEvent(e,t)&&(this.els.progress||this.makeProgressBar(),this.els.progress.style.width=e.msg+"%")},showError:function(e,t){this.isViewOfEvent(e,t)&&(this.els.preview.innerHTML="<p>"+e.msg+"</p>",this.els.preview.classList.remove("loading"),this.els.preview.classList.add("error"))},handleDrag:function(e){this.els.mediaHtml&&("dragover"!==e.type||o||(o=this.doc.createElement("div"),o.className="m-embed-dropTrap",this.els.visuals.insertBefore(o,this.els.mediaHtml)),"dragleave"===e.type&&o&&(o.parentNode.removeChild(o),o=null))},makeArea:function(){var e=this.doc,t=e.createElement("section"),i=e.createElement("a");t.className="m-embed",t.setAttribute("data-m-embed-id",this.id),t.appendChild(i),i.target=this.options.linkTarget,this.setPreviewAttributes(t),this.setLinkAttributes(i),this.editor.appendChild(t)},setPreviewAttributes:function(e){e.setAttribute("contenteditable","false"),this.els.preview=e},setLinkAttributes:function(e){e.setAttribute("data-disable-preview","true"),this.addEvent(e,"click",function(e){e.preventDefault()}),this.els.previewLink=e},makeProgressBar:function(){var e=this.doc,t=e.createElement("div"),i=e.createElement("p"),s=e.createElement("div"),n=e.createElement("div");i.textContent="Fetching preview...",s.className="m-embed-progress",t.appendChild(i),t.appendChild(s),s.appendChild(n),this.els.progress=n,this.els.preview.classList.add("loading"),this.els.previewLink.innerHTML="",this.els.previewLink.appendChild(t)},initPreview:function(e,t){var i;if(this.isViewOfEvent(e,t)){if(!e||!e.title||!e.description)return void this.showError("This url has not enough metadata to create a preview.");this.extension.options.hideToolbarAfter&&(this.extension.hideForm(),this.extension.base.getExtensionByName("toolbar").hideToolbar()),this.extension.options.deselectAfter&&this.deselect(),e.images=e.images?this.sortImages(e.images):[],e.media&&e.media.html&&(e.images.unshift(e.media),this.addEvent(this.els.preview,"dragover","trap",this.handleDrag.bind(this))),this.data=e,this.makeNav(),i=this.makeTxtContent(),e.images.length&&(this.makeMediaNav(),i=this.makeVisuals(i)),this.els.preview.classList.remove("loading"),this.els.previewLink.innerHTML="",this.els.previewLink.appendChild(i),this.isClean=!1}},makeTxtContent:function(){var e=this.doc,t=this.data,i=e.createDocumentFragment(),s=e.createElement("div"),n=e.createElement("h4"),a=e.createElement("p"),r=e.createElement("footer");return s.className="m-embed-text m-insert-no-drop",s.setAttribute("contenteditable","true"),n.textContent=t.title,a.textContent=t.description,r.textContent=t.provider_display,s.appendChild(n),s.appendChild(a),s.appendChild(r),i.appendChild(s),this.els.previewLink.href=t.url,i},makeNav:function(){var e=this.doc,t=e.createElement("nav"),i=e.createElement("button");t.className="m-insert-no-drop",i.className="m-embed-btn m-embed-btn-trash",i.title="Delete preview",i.setAttribute("aria-label","Delete preview"),i.innerHTML="fontawesome"===this.extension.getEditorOption("buttonLabels")?'<i class="fa fa-trash-o"></i>':this.extension.formCloseLabel,this.addEvent(i,"click","trash",this.destroy.bind(this)),this.els.nav=t,t.appendChild(i),this.els.preview.insertBefore(t,this.els.previewLink)},makeMediaNav:function(){var e=this.doc,t=e.createElement("div"),i=e.createElement("button");i.className="m-embed-btn m-embed-btn-trash",i.title="Delete preview media",i.setAttribute("aria-label","Delete preview media"),i.innerHTML="fontawesome"===this.extension.getEditorOption("buttonLabels")?'<i class="fa fa-times"></i>':this.extension.formCloseLabel,this.addEvent(i,"click","media:trash",this.removeMedia.bind(this)),this.els.mediaNav=t,this.els.mediaNav.appendChild(i),this.els.nav.appendChild(this.els.mediaNav)},makeVisuals:function(e){var t,i,s=this.doc,n=this.data,a=s.createElement("div");return this.els.visuals=a,this.mediaIndex=0,this.mediaTotal=n.images.length,a.className="m-embed-visual m-insert-swap",n.images[0].html&&(t=s.createElement("div"),t.innerHTML=n.media.html,t.className="m-embed-html",this.els.mediaHtml=t),(t&&this.mediaTotal>1||!t&&this.mediaTotal>0)&&(i=s.createElement("div"),i.className="m-embed-image",this.els.img=i,this.changeMedia(!0)),n.images.length>1&&this.makeVisualNav(),t&&a.appendChild(t),i&&a.appendChild(i),e.insertBefore(a,e.firstChild),e},swapVisual:function(e){var t=e.mime.split("/").pop();/(jp(e)g|gif|svg|png)/.test(t)&&(this.els.visuals.innerHTML="",this.els.img||(this.els.img=this.doc.createElement("div"),this.els.img.className="m-embed-image"),this.els.img.style.backgroundImage="url("+e.url+")",this.els.visuals.appendChild(this.els.img),this.els.mediaPrev&&(this.events["media:prev"](),this.events["media:next"](),this.els.mediaNav.removeChild(this.els.mediaPrev),this.els.mediaNav.removeChild(this.els.mediaNext)),this.els.mediaHtml=null,this.extension.trigger("m-embed:media",e,this.editor))},makeVisualNav:function(){var e=this.doc,t=e.createElement("button"),i=e.createElement("button");t.className=i.className="m-embed-btn m-embed-btn-",t.className+="prev",i.className+="next",t.title="Previous media",t.setAttribute("aria-label","Previous media"),i.title="Next media",i.setAttribute("aria-label","Next media"),t.innerHTML="fontawesome"===this.extension.getEditorOption("buttonLabels")?'<i class="fa fa-chevron-left"></i>':this.extension.formLeftLabel,i.innerHTML="fontawesome"===this.extension.getEditorOption("buttonLabels")?'<i class="fa fa-chevron-right"></i>':this.extension.formRightLabel,this.addEvent(t,"click","media:prev",this.prevMedia.bind(this)),this.addEvent(i,"click","media:next",this.nextMedia.bind(this)),this.els.mediaPrev=t,this.els.mediaNext=i,this.els.mediaNav.insertBefore(i,this.els.mediaNav.firstChild),this.els.mediaNav.insertBefore(t,i)},prevMedia:function(e){e.preventDefault(),this.mediaIndex--,this.mediaIndex<0&&(this.mediaIndex=this.mediaTotal-1),this.changeMedia()},nextMedia:function(e){e.preventDefault(),this.mediaIndex++,this.mediaIndex>this.mediaTotal-1&&(this.mediaIndex=0),this.changeMedia()},changeMedia:function(){var e=this.data.images[this.mediaIndex],t=this.els;e.html?(t.visuals.classList.add("show-html"),t.preview.classList.remove("thumbnail")):(t.img.style.backgroundImage="url("+e.url+")",this.setImageSize(e),t.mediaHtml&&t.visuals.classList.remove("show-html")),this.extension.trigger("m-embed:media",e,this.editor)},setImageSize:function(e){e.width<this.options.thumbnailSize?(this.els.preview.classList.add("thumbnail"),e.width<=this.options.thumbnailMini?this.els.img.classList.add("mini"):this.els.img.classList.remove("mini")):(this.els.preview.classList.remove("thumbnail"),this.els.img.classList.remove("mini"))},removeMedia:function(e){var t=this.els.visuals||this.els.nav.parentNode.querySelector(".m-embed-visual");e&&e.preventDefault(),t&&this.els.previewLink.removeChild(t),this.els.mediaNav&&this.els.nav.removeChild(this.els.mediaNav),this.els.visuals=this.els.mediaNav=this.els.mediaHtml=this.els.img=null,this.events["media:trash"](),this.events["media:prev"]&&(this.events["media:prev"](),this.events["media:next"]()),this.extension.trigger("m-embed:no-media",null,this.editor)},cleanup:function(){var e,t,i,s=this;for(Object.keys(this.events).forEach(function(e){s.events[e]()}),this.els.nav&&this.els.preview.removeChild(this.els.nav),this.els.preview.removeAttribute("contenteditable"),this.els.previewLink.removeAttribute("data-disable-preview"),this.els.preview.querySelector(".m-embed-text").removeAttribute("contenteditable"),e=this.els.previewLink.querySelectorAll(".m-insert-swap, .m-insert-no-drop"),t=0,i=e.length;i>t;t++)e[t].classList.remove("m-insert-swap"),e[t].classList.remove("m-insert-no-drop");this.els.visuals&&(this.els.visuals.classList.contains("show-html")?this.els.img&&(this.els.visuals.removeChild(this.els.img),this.els.img=null):this.els.mediaHtml&&(this.els.visuals.removeChild(this.els.mediaHtml),this.els.mediaHtml=null)),this.isClean=!0},revive:function(e){var t,i,s,n={};this.isClean&&(this.setPreviewAttributes(e),this.setLinkAttributes(e.getElementsByTagName("a")[0]),n.url=this.els.previewLink.href,this.makeNav(),t=this.els.preview.querySelector(".m-embed-visual"),s=this.els.preview.querySelector(".m-embed-text"),t&&(this.els.visuals=t,t.classList.add("m-insert-swap"),this.makeMediaNav(),i=t.getElementsByClassName("m-embed-html")[0],i?(n.media={html:i.innerHTML},this.els.mediaHtml=i,this.addEvent(this.els.preview,"dragover","trap",this.handleDrag.bind(this))):(i=t.getElementsByClassName("m-embed-image")[0],i&&(n.images=[{url:this.extension.window.getComputedStyle(i,null).backgroundImage}])),this.extension.trigger("m-embed:media",i,this.editor)),s&&(s.classList.add("m-insert-no-drop"),s.setAttribute("contenteditable","true")),this.extension.trigger("m-embed:success",n,this.editor),this.isClean=!1)},destroy:function(e){var t=this;e&&e.preventDefault(),Object.keys(this.events).forEach(function(e){t.events[e]()}),this.removePreview(),this.els=this.events=null,this.extension.deleteView(this.id,this.editorIndex),this.extension.trigger("m-embed:removed",null,this.editor)},removePreview:function(){this.els.preview&&(this.editor.removeChild(this.els.preview),this.els.preview=null)},deselect:function(){var e=this.extension.window,t=e.document;e.getSelection?e.getSelection().empty?e.getSelection().empty():e.getSelection().removeAllRanges&&e.getSelection().removeAllRanges():t.selection&&t.selection.empty()},sortImages:function(e){return e.length<2?e:e.sort(function(e,t){return e.width&&t.width?t.width-e.width:0})}};var h={key:null,fakeData:null,endpoint:"extract",secure:void 0,query:{},urlRe:void 0,allowMultiple:!1,linkTarget:"_blank",displayErrors:!0,hideToolbarAfter:!0,deselectAfter:!0,thumbnailSize:300,thumbnailMini:100},d=!1,m=e.extensions.form.extend({name:"mEmbed",action:"mEmbed",aria:"Embed an url",contentDefault:"<b>&#60;&#47;&#62;</b>",contentFA:'<i class="fa fa-picture-o"></i>',formLeftLabel:"&lt;",formRightLabel:"&gt;",init:function(){e.extensions.form.prototype.init.apply(this),this.extend=e.util.extend,this.options=this.extend({},h,this.getEditorOption("mEmbed")),this.views={},this.request=new n(this),this.subscribe("m-embed:cleanup",this.handleCleanup.bind(this)),this.subscribe("m-embed:revive",this.handleRevive.bind(this))},handleClick:function(t){t.preventDefault(),t.stopPropagation();var i=e.selection.getSelectionRange(this.document);return d=!1,this._selection=i.toString(),this.isDisplayed()||this.showForm(),!1},isDisplayed:function(){return"block"===this.getForm().style.display},showForm:function(){var e=this.checkURL(this._selection);this.base.saveSelection(),this.hideToolbarDefaultActions(),e||(this.getForm().classList.add("error"),d=!0),this.getInput().value=e||this._selection,this.getForm().style.display="block",this.setToolbarPosition()},getForm:function(){return this.form||(this.form=this.createForm()),this.form},hideForm:function(){var e=this.getForm();e.classList.remove("error"),e.style.display="none",this.getInput().value=""},doFormCancel:function(){this.base.restoreSelection(),this.base.checkSelection()},createForm:function(){var e=this.document.createElement("div");return e.className="medium-editor-toolbar-form",e.id="medium-editor-toolbar-embed-"+this.getEditorId(),e.innerHTML=this.getTemplate(),this.attachFormEvents(e),e},getTemplate:function(){var e=['<input type="text" class="medium-editor-toolbar-input" value="">'];return e.push('<a href="#" class="medium-editor-toolbar-save">',"fontawesome"===this.getEditorOption("buttonLabels")?'<i class="fa fa-check"></i>':this.formSaveLabel,"</a>"),e.push('<a href="#" class="medium-editor-toolbar-close">',"fontawesome"===this.getEditorOption("buttonLabels")?'<i class="fa fa-times"></i>':this.formCloseLabel,"</a>"),e.join("")},getInput:function(){return this.getForm().querySelector("input.medium-editor-toolbar-input")},attachFormEvents:function(e){var t=e.querySelector(".medium-editor-toolbar-close"),i=e.querySelector(".medium-editor-toolbar-save"),s=e.querySelector(".medium-editor-toolbar-input");this.on(s,"keyup",this.onTextInput.bind(this)),this.on(t,"click",this.onClose.bind(this)),this.on(i,"click",this.onSubmit.bind(this),!0)},onTextInput:function(t){var i;return t.keyCode===e.util.keyCode.ENTER?(t.preventDefault(),void this.onSubmit(t)):t.keyCode===e.util.keyCode.ESCAPE?(t.preventDefault(),void this.doFormCancel()):(i=this.checkURL(this.getInput().value),void(i?(d=!1,this.getForm().classList.remove("error")):(d=!0,this.getForm().classList.add("error"))))},onClose:function(e){e.preventDefault(),e.stopPropagation(),this.doFormCancel()},onSubmit:function(e){var t,i,s=this.base.getFocusedElement(),n=parseInt(s.getAttribute("medium-editor-index"),10);e.preventDefault(),e.stopPropagation();var a=this.checkURL(this.getInput().value);d||(i=new l(this,s,n),this.views[n]?this.options.allowMultiple||(t=Object.keys(this.views[n])[0],t&&this.views[n][t].destroy()):this.views[n]={},this.views[n][i.id]=i,i.makeArea(),this.request.init(a,{viewId:i.id,editor:s}))},handleCleanup:function(e){var t,i;if(e){t=parseInt(e.getAttribute("medium-editor-index"),10);for(i in this.views[t])this.views[t].hasOwnProperty(i)&&this.views[t][i].cleanup()}},handleRevive:function(e){var t,i,s;if(e&&(t=parseInt(e.getAttribute("medium-editor-index"),10),!isNaN(t))){this.views[t]=this.views[t]?this.views[t]:{},i=e.getElementsByClassName("m-embed");for(var n=0,a=i.length;a>n;n++)s=i[n].getAttribute("data-m-embed-id"),this.views[t][s]?this.views[t][s].revive(i[n]):(s=new l(this,e,t),this.views[t][s.id]=s,s.revive(i[n]))}},deleteView:function(e,t){this.views[t][e]=null,delete this.views[t][e]},checkURL:function(e){return e=e.trim(),this.request.urlRe.test(e)?e:null}});return m});